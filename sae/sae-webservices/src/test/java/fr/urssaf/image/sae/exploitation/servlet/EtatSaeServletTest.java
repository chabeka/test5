package fr.urssaf.image.sae.exploitation.servlet;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.StringWriter;

import org.jdom.Element;
import org.jdom.output.Format;
import org.jdom.output.XMLOutputter;
import org.junit.Test;

import fr.urssaf.image.sae.exploitation.modele.CaptureMasseInfo;
import fr.urssaf.image.sae.exploitation.modele.ConfigurationDfce;
import fr.urssaf.image.sae.exploitation.service.ConfigDfceService;
import fr.urssaf.image.sae.exploitation.service.DfceInfoService;

@SuppressWarnings( { "PMD.AtLeastOneConstructor" })
public class EtatSaeServletTest {
   
   @Test
   public void isDfceConsultationUpSuccess() throws FileNotFoundException, IOException {
      File file = new File("src/test/resources/exploitation/sae-dfce-config-success.properties");
      ConfigurationDfce configurationDfce = ConfigDfceService.getConfigDfce(file);
      assertTrue("IsDfceConsult n'est pas à true", DfceInfoService.isDfceConsultationUp(configurationDfce));
      
   }
   
   @Test(expected = FileNotFoundException.class)
   public void isDfceConsultationUpFileNotExists() throws FileNotFoundException, IOException {
      File file = new File("src/test/resources/exploitation/sae-dfc-config-success.properties");
      ConfigurationDfce configurationDfce = ConfigDfceService.getConfigDfce(file);
      DfceInfoService.isDfceConsultationUp(configurationDfce);
      
   }
   
   /* Erreur sur le numéro de port
    * 8080 au lieu de 8080*/
   @Test
   public void isDfceConsultationUpFailureElementManquant() throws FileNotFoundException, IOException {
      File file = new File("src/test/resources/exploitation/sae-dfce-config-failure.properties");
      ConfigurationDfce configurationDfce = ConfigDfceService.getConfigDfce(file);
      assertFalse("IsDfceConsult n'est pas à false", DfceInfoService.isDfceConsultationUp(configurationDfce));
      
   }
   
   /* Vérification de l'ecriture du flux XML */
   @Test
   public void writeXmlSuccess() throws IOException {
      boolean isDfceUp = true;
      boolean dfceConsultUp = true;
      CaptureMasseInfo captureMI = new CaptureMasseInfo();
      captureMI.setEnCours(true);
      captureMI.setEtatAvancement("debut");
      
      Element actual = EtatSaeServlet.writeXml(isDfceUp, dfceConsultUp, captureMI);
      
      Element attendu = getElementTrue();
      
      assertEquals("Flux xml incorrect", actual.toString(), attendu.toString());
   }
   
   private Element getElementTrue() {
      // Element racine
      Element racine = new Element("application");
      racine.setAttribute("name", "SAE");
      
      // Element fils - composants
      Element composant = new Element("composants");
      
      // Elements composant
      Element composant1 = new Element("composant");
      composant1.setAttribute("name", "dfce_serveur");
      composant1.setAttribute("test", "OK");
      composant.addContent(composant1);
      
      Element composant2 = new Element("composant");
      composant2.setAttribute("name", "dfce_consultation");
      composant2.setAttribute("test", "OK");
      
      composant.addContent(composant2);
      
      racine.addContent(composant);
      
      getElementCaptureMasse(racine);
      
      return racine;
   }
   
   private Element getElementCaptureMasse(Element racine) {
      // Element fils - informations
      Element composant = new Element("informations");
      
      // Elements info
      Element composant1 = new Element("info");
      composant1.setAttribute("name", "captureMasse_estEnCours");
      composant1.setAttribute("valeur", "OUI");
      composant.addContent(composant1);
      
      Element composant2 = new Element("info");
      composant2.setAttribute("name", "captureMasse_avancement");
      composant2.setAttribute("valeur", "debut");
      composant.addContent(composant2);
      
      
      racine.addContent(composant);
      
      return racine;
   }
   
   @Test
   public void serviceUpSuccess() throws IOException {
      
      File file = new File("src/test/resources/exploitation/sae-dfce-config-success.properties");
      ConfigurationDfce configurationDfce = ConfigDfceService.getConfigDfce(file);
      
      CaptureMasseInfo captureMI = new CaptureMasseInfo();
      captureMI.setEnCours(true);
      captureMI.setEtatAvancement("debut");
      
      StringWriter stringActual = new StringWriter();
      EtatSaeServlet.serviceUp(configurationDfce, captureMI, stringActual);
      
      StringWriter stringAttendu = getStringWriter();
      
      assertEquals("Resultat inattendu !", stringActual.toString(), stringAttendu.toString());
   }
   
   private StringWriter getStringWriter() throws IOException {
      // Initialisation du flux XML
      Element xml = getElementTrue();
      
      //JDOM - Ecriture du flux XML
      XMLOutputter out = new XMLOutputter(Format.getPrettyFormat());
      StringWriter stringWriterTest = new StringWriter();
      out.output(xml, stringWriterTest);
      
      return stringWriterTest;
   }
   
   
}
