package fr.urssaf.image.sae.exploitation.controller;

import java.io.IOException;
import java.io.Writer;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.jdom.Element;
import org.jdom.output.Format;
import org.jdom.output.XMLOutputter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import fr.urssaf.image.sae.exploitation.service.DfceInfoService;

/**
 * Servlet implementation class EtatDfceServlet
 */
@Controller
@RequestMapping(value = "/SAETest")
public class EtatSaeServletController {
   
	private static final long serialVersionUID = 1L;
	
	private static final String ETAT_DFCE_OK = "OK";
   private static final String ETAT_DFCE_KO = "KO";
   private static final String TEST = "test";
   private static final String NAME = "name";
   
   @Autowired
   private DfceInfoService dfceInfoService;
   
   
   /**
	 * @throws IOException 
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
   @RequestMapping(method = RequestMethod.GET)
   protected final void doGet(HttpServletRequest request,
         HttpServletResponse response
         ) throws IOException {
      
      // Type MIME de la réponse HTTP
      response.setContentType("text/xml; charset=UTF-8");
      
      // Appel de la méthode principale
      serviceUp(response.getWriter());
            
   }
	
	/**
	 * Methode qui retourne les valeurs à la méthode doGet()<br>
	 * necessaire à la réponse affichée dans le navigateur.
	 * 
	 * @param writer 
	 *               afficher dans le navigateur de la réponse
	 * @throws IOException
	 *               exception
	 */
	public final void serviceUp(Writer writer) throws IOException {
	   
	   // Test de DFCE serveur up
      boolean dfceUp = dfceInfoService.isDfceUp();
      
      // Test du couple DFCE + Cassandra
      boolean dfceConsultUp;
      if (dfceUp) {
         dfceConsultUp = dfceInfoService.isDfceConsultationUp();
      } else {
         dfceConsultUp = false;
      }
      
      // Initialisation du flux XML
      Element xml = writeXml(dfceUp, dfceConsultUp);
      
      //JDOM - Ecriture du flux XML
      XMLOutputter out = new XMLOutputter(Format.getPrettyFormat());
      out.output(xml, writer);
	   
	}
	

	/**
	 * @throws IOException 
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	@RequestMapping(method = RequestMethod.POST)
	protected final void doPost(HttpServletRequest request,
         HttpServletResponse response) throws IOException {
	   doGet(request, response);
	}
	
	/**
	 * Ecriture du flux XML indiquant les etats de DFCE, couple DFCE/Cassandra<br>
	 * et l'etat de la capture de masse.
	 * 
	 * @param isDfceUp
	 *               boolean si dfce est up
	 * @param isDfceConsultUp 
	 *               si dfce/casandra is up
	 *               
	 * @return l'element Xml representant le flux              
	 */
	public final Element writeXml(boolean isDfceUp, boolean isDfceConsultUp) {

      // Element racine
      Element racine = new Element("application");
      racine.setAttribute(NAME, "SAE");
      
      racine = writeXmlDfce(racine, isDfceUp, isDfceConsultUp);
      
      return racine;
      
	}
	
	
	/**
	 * Méthode permettant de générér un flux XML
    * pour savoir si l'API DFCE est actif
    * et si le couple DFCE/Cassandra est actif.
	 *  
	 * @param racine
	 * @param isDfceUp
	 * @param isDfceConsultUp
	 * @return element racine du flux XML
	 */
	private Element writeXmlDfce(Element racine, boolean isDfceUp, boolean isDfceConsultUp) {
	   // Element fils - composants
      Element composant = new Element("composants");
      
      // Elements composant
      Element composant1 = new Element("composant");
      composant1.setAttribute(NAME, "dfce_serveur");
      if (isDfceUp) {
         composant1.setAttribute(TEST, ETAT_DFCE_OK);
      } else {
         composant1.setAttribute(TEST, ETAT_DFCE_KO);
      }
      
      composant.addContent(composant1);
      
      Element composant2 = new Element("composant");
      composant2.setAttribute(NAME, "dfce_consultation");
      if (isDfceConsultUp) {
         composant2.setAttribute(TEST, ETAT_DFCE_OK);
      } else {
         composant2.setAttribute(TEST, ETAT_DFCE_KO);
      }
      
      composant.addContent(composant2);
      
      racine.addContent(composant);
      
      return racine;
	}
	
}
